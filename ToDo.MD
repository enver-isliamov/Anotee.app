
# üöú SmoTree Refactoring Roadmap

## üìã –ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π

## üöÄ –≠—Ç–∞–ø VII: SaaS –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Contextual Permissions)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–≠—Ç–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω.**

–ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç –∂–µ—Å—Ç–∫–∏—Ö —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ –ø—Ä–∞–≤–∞–º, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ.

- [x] **Login Refactor:** Google-—é–∑–µ—Ä –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞ (`Admin`), –Ω–æ –µ–≥–æ –ø—Ä–∞–≤–∞ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–∞.
- [x] **Dashboard:** –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –µ–≥–æ –í–ª–∞–¥–µ–ª—å—Ü—É (`ownerId`).
- [x] **Project View:** –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Upload/Delete) –¥–æ—Å—Ç—É–ø–Ω—ã –í–ª–∞–¥–µ–ª—å—Ü—É –∏–ª–∏ —á–ª–µ–Ω–∞–º –∫–æ–º–∞–Ω–¥—ã (–Ω–µ –ì–æ—Å—Ç—è–º).
- [x] **Player:** –ü—Ä–∞–≤–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ (`canManage`) –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ (–í–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –ö–æ–º–∞–Ω–¥–∞).
- [x] **Fix Race Condition:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Ç–æ–∫–æ–≤ Login -> Join -> Fetch –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π.

## üöë –≠—Ç–∞–ø VIII: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∏ –û—á–∏—Å—Ç–∫–∞ (Security Cleanup)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–≠—Ç–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω.**

–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–ª–≥–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.

- [x] **Legacy Code:** –£–¥–∞–ª–∏—Ç—å/–ó–∞–≥–ª—É—à–∏—Ç—å `api/join.js`, `api/guest.js`.
- [x] **Types:** –£–¥–∞–ª–∏—Ç—å deprecated `UserRole` –∏–∑ `types.ts` –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
- [x] **Security:** –ó–∞—â–∏—Ç–∏—Ç—å `api/setup.js` —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º.
- [x] **Security:** –£—Å–∏–ª–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ `api/upload.js` (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –ø—Ä–æ–µ–∫—Ç).
- [x] **Integration:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ Google Drive –¥–ª—è Enterprise –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (Fallback strategy).

---

## üõë –≠—Ç–∞–ø IX: Critical Refactoring & Bug Fixes (–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å)
**–°—Ç–∞—Ç—É—Å:** üöß **–í —Ä–∞–±–æ—Ç–µ**

–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –î–∞–Ω–Ω—ã–µ
- [x] **Split-Brain Problem (Team Data):**
    - *–°—É—Ç—å:* –ü–æ–ª–µ `project.team` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Postgres —è–≤–ª—è–µ—Ç—Å—è –∫–µ—à–µ–º –∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —á–ª–µ–Ω–∞–º–∏ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ Clerk.
    - *–°–∏–º–ø—Ç–æ–º:* –£–¥–∞–ª–µ–Ω–Ω—ã–π –∏–∑ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤–∏–¥–µ—Ç—å –ø—Ä–æ–µ–∫—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ, –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ –Ω–µ –æ–±–Ω–æ–≤–∏—Ç –ø—Ä–æ–µ–∫—Ç –≤—Ä—É—á–Ω—É—é.
    - *–†–µ—à–µ–Ω–∏–µ:* `ProjectView` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `useOrganization` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∫–µ—à –ë–î –¥–ª—è SaaS-–ø—Ä–æ–µ–∫—Ç–æ–≤.

- [x] **Optimistic Locking Conflicts:**
    - *–°—É—Ç—å:* `api/data.js` –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤–µ—Å—å JSON –ø—Ä–æ–µ–∫—Ç–∞ —Ü–µ–ª–∏–∫–æ–º.
    - *–†–∏—Å–∫:* –ï—Å–ª–∏ –¥–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç —Ä–∞–∑–Ω—ã–µ –∞—Å—Å–µ—Ç—ã –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∏–∑ –Ω–∏—Ö –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.
    - *–†–µ—à–µ–Ω–∏–µ:* –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `PATCH /api/data` –¥–ª—è —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ `Smart Merge` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

### 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (AI & Media)
- [ ] **AI Memory Leak (Browser Crash):**
    - *–°—É—Ç—å:* `services/audioUtils.ts` –∑–∞–≥—Ä—É–∂–∞–µ—Ç **–≤–µ—Å—å** –≤–∏–¥–µ–æ—Ñ–∞–π–ª –≤ `ArrayBuffer` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∞—É–¥–∏–æ.
    - *–†–∏—Å–∫:* –î–ª—è –≤–∏–¥–µ–æ 4K —Ä–∞–∑–º–µ—Ä–æ–º >500MB —ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç **Out Of Memory** –∫—Ä–∞—à –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.
    - *–ó–∞–¥–∞—á–∞:* –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ –ø–æ—Ç–æ–∫–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π FFmpeg (Vercel Functions / Edge). [!–û–±—è–Ω–∏—Ç—å –º–Ω–µ —Ä–∞–∑–Ω–∏—Ü—É, —Å—Ç–æ–∏–º–æ—Å—Ç—å, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏,  –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ –∫ –ø–æ–º–Ω–∏–º–∞–Ω–∏—é –ø–Ω—É–Ω–∫—Ç—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ.]

- [ ] **Thumbnail Generation CORS:**
    - *–°—É—Ç—å:* `generateVideoThumbnail` —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ `<canvas>` –∫–ª–∏–µ–Ω—Ç–∞. –î–ª—è –≤–∏–¥–µ–æ —Å Drive/Blob —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Tainted Canvas) –∏–∑-–∑–∞ CORS –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
    - *–°–∏–º–ø—Ç–æ–º:* –í–º–µ—Å—Ç–æ –ø—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞-–∫–∞—Ä—Ç–∏–Ω–∫–∞.
    - *–ó–∞–¥–∞—á–∞:* –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–º–±–Ω–µ–π–ª –Ω–∞ —ç—Ç–∞–ø–µ –∑–∞–≥—Ä—É–∑–∫–∏ (upload) –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é. [!–û–±—è–Ω–∏—Ç—å –º–Ω–µ —Ä–∞–∑–Ω–∏—Ü—É, —Å—Ç–æ–∏–º–æ—Å—Ç—å, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏,  –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ –∫ –ø–æ–º–Ω–∏–º–∞–Ω–∏—é –ø–Ω—É–Ω–∫—Ç—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ.]

### 3. Google Drive Integration
- [ ] **Playback Reliability:**
    - *–°—É—Ç—å:* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ `drive.google.com/uc?export=download` —è–≤–ª—è–µ—Ç—Å—è "—Ö–∞–∫–æ–º". Google –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –∂–µ—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã (rate limits) –Ω–∞ —Ç–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã.
    - *–°–∏–º–ø—Ç–æ–º:* –í–∏–¥–µ–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π 403 Forbidden.
    - *–ó–∞–¥–∞—á–∞:* –í–Ω–µ–¥—Ä–∏—Ç—å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Drive Embed API. [–û–±—è—Å–Ω–∏—Ç—å –º–Ω–µ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º. –≥–ª–∞–≤–Ω–æ–µ –ø–ª–∞–≤–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ –≤ –ø–ª–µ–µ—Ä–µ –∏ —É–¥–æ–±–Ω–∞—è –ø—Ä–µ—Ä–µ–º–æ—Ç–∫–∞ —Å —Ç–æ—á–Ω–æ—Å—å—é –ø–æ —Ç–∞–π–º–∫–æ–¥—É –ø—Ä–∏ —Å–≤–∞–π–ø–µ –ø–∞–ª—å—Ü–µ–º]

- [ ] **Upload Permission Fail:** [–û–±—è—Å–Ω–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö] 
    - *–°—É—Ç—å:* `GoogleDriveService` –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ `anyone/reader`. –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ Google Workspace —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É—é—Ç —ç—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏.
    - *–°–∏–º–ø—Ç–æ–º:* –§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –Ω–æ –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω.

### 4. Code Quality & Cleanup
- [ ] **App.tsx Bloat:** –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (`handleUploadAsset`) –∑–∞–Ω–∏–º–∞–µ—Ç >100 —Å—Ç—Ä–æ–∫ –≤ –∫–æ—Ä–Ω–µ–≤–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ. –í—ã–Ω–µ—Å—Ç–∏ –≤ —Ö—É–∫ `useUploadManager`.
- [ ] **Legacy Types:** –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ `role` –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `User` –≤ `types.ts` (–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ Clerk Roles).
- [ ] **API Consistency:** `api/comment.js` –≤—Å–µ –µ—â–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–º—É –º–∞—Å—Å–∏–≤—É `team` –≤–Ω—É—Ç—Ä–∏ JSON, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ Clerk Org.
- [ ] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Clerk** –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ —á—Ç–æ –µ—â–µ –Ω–µ –±–≤–ª–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ Clerk —Å –ø–æ–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –∏ —à–∞–≥–∞–º–∏ —Ä–∞–µ–ª–∏–∑–∞—Ü–∏–∏.
