
# üöú SmoTree Refactoring Roadmap

## üìã –ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π

## üöÄ –≠—Ç–∞–ø VII: SaaS –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Contextual Permissions)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–≠—Ç–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω.**

## üöë –≠—Ç–∞–ø VIII: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∏ –û—á–∏—Å—Ç–∫–∞ (Security Cleanup)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–≠—Ç–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω.**

---

## üõë –≠—Ç–∞–ø IX: Critical Refactoring & Bug Fixes (–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å)
**–°—Ç–∞—Ç—É—Å:** üöß **–í —Ä–∞–±–æ—Ç–µ**

–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –î–∞–Ω–Ω—ã–µ
- [x] **Split-Brain Problem (Team Data):**
    - *–†–µ—à–µ–Ω–∏–µ:* `ProjectView` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `useOrganization` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
- [x] **Optimistic Locking Conflicts:**
    - *–†–µ—à–µ–Ω–∏–µ:* –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `PATCH /api/data` –¥–ª—è —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ `Smart Merge` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

### 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (AI & Media)
- [x] **AI Memory Leak (Browser Crash):**
    - *–°—É—Ç—å:* `services/audioUtils.ts` –∑–∞–≥—Ä—É–∂–∞–µ—Ç **–≤–µ—Å—å** –≤–∏–¥–µ–æ—Ñ–∞–π–ª –≤ `ArrayBuffer` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∞—É–¥–∏–æ.
    - *–†–µ—à–µ–Ω–∏–µ:* –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω **Safety Guard**. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (`HEAD` request) –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π. –õ–∏–º–∏—Ç 300MB. –î–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≤–º–µ—Å—Ç–æ –∫—Ä–∞—à–∞ –≤–∫–ª–∞–¥–∫–∏.
    - *Note:* –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å—Ç—Ä–∏–º–∏–Ω–≥ (WebCodecs/ffmpeg.wasm) –æ—Ç–ª–æ–∂–µ–Ω –¥–æ –≠—Ç–∞–ø–∞ X (Performance), —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

- [x] **Thumbnail Generation CORS:**
    - *–°—É—Ç—å:* –û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Canvas –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ –∫–∞–¥—Ä–æ–≤ —Å —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ (Drive).
    - *–†–µ—à–µ–Ω–∏–µ:*
        1. –î–æ–±–∞–≤–ª–µ–Ω `video.crossOrigin = "anonymous"`.
        2. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω **Smart Fallback**: –µ—Å–ª–∏ CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç —á—Ç–µ–Ω–∏–µ, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ (Canvas) —Å –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞ –∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º, –≤–º–µ—Å—Ç–æ –±–∏—Ç–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏.

### 3. Google Drive Integration
- [ ] **Playback Reliability:**
    - *–°—É—Ç—å:* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ `drive.google.com/uc?export=download` —è–≤–ª—è–µ—Ç—Å—è "—Ö–∞–∫–æ–º". Google –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –∂–µ—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã (rate limits) –Ω–∞ —Ç–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã.
    - *–°–∏–º–ø—Ç–æ–º:* –í–∏–¥–µ–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π 403 Forbidden.
    - *–ó–∞–¥–∞—á–∞:* –í–Ω–µ–¥—Ä–∏—Ç—å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Drive Embed API.

- [ ] **Upload Permission Fail:**
    - *–°—É—Ç—å:* `GoogleDriveService` –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ `anyone/reader`. –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ Google Workspace —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É—é—Ç —ç—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏.
    - *–°–∏–º–ø—Ç–æ–º:* –§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –Ω–æ –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω.

### 4. Code Quality & Cleanup
- [ ] **App.tsx Bloat:** –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (`handleUploadAsset`) –∑–∞–Ω–∏–º–∞–µ—Ç >100 —Å—Ç—Ä–æ–∫ –≤ –∫–æ—Ä–Ω–µ–≤–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ. –í—ã–Ω–µ—Å—Ç–∏ –≤ —Ö—É–∫ `useUploadManager`.
- [ ] **Legacy Types:** –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ `role` –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `User` –≤ `types.ts` (–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ Clerk Roles).
- [ ] **API Consistency:** `api/comment.js` –≤—Å–µ –µ—â–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–º—É –º–∞—Å—Å–∏–≤—É `team` –≤–Ω—É—Ç—Ä–∏ JSON, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ Clerk Org.
- [ ] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Clerk** –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ —á—Ç–æ –µ—â–µ –Ω–µ –±–≤–ª–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ Clerk —Å –ø–æ–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –∏ —à–∞–≥–∞–º–∏ —Ä–∞–µ–ª–∏–∑–∞—Ü–∏–∏.
