
# üí≥ –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –ÆKassa (Recurrent)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ (Free/Pro) —Å –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ–º, –∏—Å–ø–æ–ª—å–∑—É—è **–ÆKassa + Clerk + Vercel Cron**.

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

1.  **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ **Clerk Public Metadata** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    *   `plan`: 'free' | 'pro'
    *   `expiresAt`: Timestamp (–¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞).
    *   `yookassaPaymentMethodId`: ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è.
2.  **–ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç –≤—Ä—É—á–Ω—É—é, –º—ã –ø–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥ `save_payment_method: true`.
3.  **–û–±—Ä–∞–±–æ—Ç–∫–∞:** –í–µ–±—Ö—É–∫ –ÆKassa –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É -> –º—ã –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º `expiresAt` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–∞—Ä—Ç—ã.
4.  **–ê–≤—Ç–æ-–ø—Ä–æ–¥–ª–µ–Ω–∏–µ:** Vercel Cron (–±–µ—Å–ø–ª–∞—Ç–Ω–æ) —Ä–∞–∑ –≤ –¥–µ–Ω—å –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º –∏ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ –ÆKassa –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–µ.

---

## üõë –≠–¢–ê–ü 1: –ü–û–î–ì–û–¢–û–í–ö–ê (–í–ê–®–ò –î–ï–ô–°–¢–í–ò–Ø) üõë

–≠—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa **–¥–æ** –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ –±–æ–µ–≤–æ–π —Ä–µ–∂–∏–º.

1.  **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –î–æ–≥–æ–≤–æ—Ä:**
    - [x] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [yookassa.ru](https://yookassa.ru/). (–°—Ç–∞—Ç—É—Å: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
    *   –î–ª—è —Ç–µ—Å—Ç–æ–≤ –º–æ–∂–Ω–æ –Ω–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä —Å—Ä–∞–∑—É, –∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–¢–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω**.

2.  **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π (Test Mode):**
    *   –í –õ–ö –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** -> **–ö–ª—é—á–∏ API**.
    *   –í–∞–º –Ω—É–∂–µ–Ω **Shop ID** (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞).
    *   –í–∞–º –Ω—É–∂–µ–Ω **Secret Key** (–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á).
    *   *–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö –≤ –±–ª–æ–∫–Ω–æ—Ç.*

3.  **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Webhooks):**
    *   –í —Ä–∞–∑–¥–µ–ª–µ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** -> **HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**.
    *   **URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `https://–≤–∞—â-–¥–æ–º–µ–Ω.vercel.app/api/payment?action=webhook` (–û–ë–ù–û–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º consolidated endpoint).
    *   –û—Ç–º–µ—Ç—å—Ç–µ —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`.

4.  **–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π (–í–∞–∂–Ω–æ!):**
    *   –ù–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, —á—Ç–æ —É –≤–∞—Å –≤–∫–ª—é—á–µ–Ω—ã **"–†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏" (–ë–µ–∑–∞–∫—Ü–µ–ø—Ç–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è)**. –ë–µ–∑ —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.

---

## ‚öôÔ∏è –≠—Ç–∞–ø 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env` (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –≤ Vercel):
    *   `YOOKASSA_SHOP_ID`
    *   `YOOKASSA_SECRET_KEY`
    *   `CRON_SECRET`
- [x] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `uuid`.

---

## üíª –≠—Ç–∞–ø 3: –ë—ç–∫–µ–Ω–¥ (API Routes)

**–°—Ç–∞—Ç—É—Å: ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û (–° –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø–æ–¥ –ª–∏–º–∏—Ç—ã Vercel)**

### 3.1. –ï–¥–∏–Ω—ã–π —Ö–µ–Ω–¥–ª–µ—Ä (`api/payment.js`)
–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∏ –≤–µ–±—Ö—É–∫.

- [x] **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (`?action=init`):**
    *   –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –≤ –ÆKassa.
    *   –ü–µ—Ä–µ–¥–∞–µ—Ç `save_payment_method: true`.
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `confirmation_url`.
- [x] **–í–µ–±—Ö—É–∫ (`?action=webhook`):**
    *   –°–ª—É—à–∞–µ—Ç `payment.succeeded`.
    *   –û–±–Ω–æ–≤–ª—è–µ—Ç Clerk Metadata (`plan: 'pro'`, `expiresAt`, `paymentMethodId`).
- [x] **–û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (`?action=cancel_sub`):**
    *   –£–¥–∞–ª—è–µ—Ç `paymentMethodId` –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –æ—Ç–∫–ª—é—á–∞—è –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ.

### 3.2. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ (`api/cron.js`)
–°–∫—Ä–∏–ø—Ç –¥–ª—è Vercel Cron.

- [x] **–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:**
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `Authorization: Bearer CRON_SECRET`.
    *   –ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º `expiresAt`.
    *   –°–æ–∑–¥–∞–µ—Ç –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –≤ –ÆKassa –ø–æ `payment_method_id`.
    *   –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø—Ä–∏ —É—Å–ø–µ—Ö–µ.

---

## üñ• –≠—Ç–∞–ø 4: –§—Ä–æ–Ω—Ç–µ–Ω–¥ (UI)

**–°—Ç–∞—Ç—É—Å: ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

### 4.1. –õ–æ–≥–∏–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- [x] **–•—É–∫ `useSubscription`:**
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `metadata.plan` –∏ –¥–∞—Ç—É `expiresAt`.
    *   –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `checkStatus()` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.

### 4.2. UI –û–ø–ª–∞—Ç—ã
- [x] **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç `RoadmapBlock`:**
    *   –ö–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å –∑–∞ 2900‚ÇΩ" –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ API.
    *   –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (Loading state).
    *   –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

### 4.3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (Success Page)
- [x] **`App.tsx`:**
    *   –û—Ç–ª–∞–≤–ª–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `?payment=success` –∏ `?payment=canceled`.
    *   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
    *   **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (`user.reload()`), —á—Ç–æ–±—ã —Å—Ç–∞—Ç—É—Å Pro –ø–æ—è–≤–∏–ª—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

### 4.4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π
- [x] **`Profile.tsx`:**
    *   –ë–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–ª—è Pro –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π).
    *   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è.
    *   –ö–Ω–æ–ø–∫–∞ **"–û—Ç–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ"** (–≤—ã–∑—ã–≤–∞–µ—Ç API `cancel_sub`).

---

## üõë –≠–¢–ê–ü 5: –ù–ê–°–¢–†–û–ô–ö–ê CRON

**–°—Ç–∞—Ç—É—Å: ‚úÖ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ì–û–¢–û–í–ê**

- [x] –§–∞–π–ª `vercel.json` –Ω–∞—Å—Ç—Ä–æ–µ–Ω:
```json
{
  "crons": [
    {
      "path": "/api/cron",
      "schedule": "0 10 * * *" 
    }
  ]
}
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (–§–∏–Ω–∞–ª—å–Ω—ã–π)

- [ ] üõë (User) –í—ã —Å–æ–∑–¥–∞–ª–∏ –º–∞–≥–∞–∑–∏–Ω –≤ –ÆKassa –∏ –ø–æ–ª—É—á–∏–ª–∏ `shopId`.
- [ ] üõë (User) –í—ã –¥–æ–±–∞–≤–∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Vercel (`Settings -> Environment Variables`).
- [ ] üõë (User) –í—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ Webhook URL –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa –Ω–∞ `https://.../api/payment?action=webhook`.
- [x] (Code) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ö—É–ø–∏—Ç—å", —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂.
- [x] (Code) –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –∏ –≤—ã–¥–∞—á–∞ –ø—Ä–∞–≤.
- [x] (Code) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π (–æ—Ç–º–µ–Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è).
- [x] (Code) Cron-–∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.
