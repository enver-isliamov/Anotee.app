
# üí≥ –ë–∏–ª–ª–∏–Ω–≥ –∏ –ü–æ–¥–ø–∏—Å–∫–∏ (Architecture)

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ (–ÆKassa + Prodamus).

**–°—Ç–∞—Ç—É—Å:** üöÄ **–í –ü—Ä–æ–¥–∞–∫—à–µ–Ω–µ**

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –î–∞–Ω–Ω—ã—Ö

1.  **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Clerk Public Metadata):**
    *   `plan`: 'free' | 'pro' | 'lifetime'
    *   `expiresAt`: Timestamp (–¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è).
    *   `yookassaPaymentMethodId`: –¢–æ–∫–µ–Ω –∫–∞—Ä—Ç—ã –¥–ª—è –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ÆKassa).
    *   `billingStatus`: 'active' | 'canceled'.

2.  **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (Postgres `system_settings`):**
    *   –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ü–µ–Ω—ã, —Ç–µ–∫—Å—Ç—ã —Ç–∞—Ä–∏—Ñ–æ–≤, –∫–ª—é—á–∏ API) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î.
    *   –£–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **Admin Panel** -> **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**.
    *   –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—É—é —á–∞—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥–∞ —á–µ—Ä–µ–∑ `api/admin?action=get_payment_config`.

3.  **–ê–≤—Ç–æ-–ø—Ä–æ–¥–ª–µ–Ω–∏–µ (Cron):**
    *   –°–∫—Ä–∏–ø—Ç `api/cron.js` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Vercel Cron —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏.
    *   –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å `plan: 'pro'` –∏ –∞–∫—Ç–∏–≤–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º –∫–∞—Ä—Ç—ã.

---

## ‚öôÔ∏è –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –ü–ª–∞—Ç–µ–∂–µ–π

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ ¬´–Ω–∞ –ª–µ—Ç—É¬ª —á–µ—Ä–µ–∑ –ê–¥–º–∏–Ω–∫—É.

### 1. –ÆKassa (–û—Å–Ω–æ–≤–Ω–æ–π)
*   **–†–µ–∂–∏–º:** –†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (Autopay).
*   **–§–ª–æ—É:**
    1.  –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ —Å `save_payment_method: true`.
    2.  –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `payment_method_id` –≤ Clerk.
    3.  Cron –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å `/payments` —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º ID –±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### 2. Prodamus (–†–µ–∑–µ—Ä–≤–Ω—ã–π/–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)
*   **–†–µ–∂–∏–º:** –°—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É.
*   **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
    *   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞—Ä—É–±–µ–∂–Ω—ã–µ –∫–∞—Ä—Ç—ã (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞).
    *   –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (Manual renew).
    *   Webhook –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ–ø–ª–∞—Ç—É –∏ –≤—ã–¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø.

---

## üíª –ë—ç–∫–µ–Ω–¥ (API Routes)

### `api/payment.js`
–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

- [x] **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (`?action=init`):**
    *   –ß–∏—Ç–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –∏–∑ –ë–î.
    *   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `activeProvider`.
- [x] **–í–µ–±—Ö—É–∫ (`?action=webhook`):**
    *   –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `payment.succeeded` (–ÆKassa).
    *   –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Prodamus.
    *   –ê—Ç–æ–º–∞—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- [x] **–û—Ç–º–µ–Ω–∞ (`?action=cancel_sub`):**
    *   –°—Ç–∏—Ä–∞–µ—Ç —Ç–æ–∫–µ–Ω –∫–∞—Ä—Ç—ã, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è —Å–ø–∏—Å–∞–Ω–∏—è.

### `api/admin.js`
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.

- [x] **GET `get_payment_config`:** –ü—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ —Ü–µ–Ω–Ω–∏–∫–∞ (—Ü–µ–Ω—ã, —Ñ–∏—á–∏).
- [x] **POST `update_payment_config`:** –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π –∏ —Ç–µ–∫—Å—Ç–æ–≤ (–¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º).

---

## üñ• –§—Ä–æ–Ω—Ç–µ–Ω–¥ (UI)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `RoadmapBlock.tsx`
*   **Skeleton Loading:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–≥–ª—É—à–∫—É –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥ –∏–∑ –ë–î.
*   **Dynamic Pricing:** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ü–µ–Ω—ã –∏ —Ñ–∏—á–∏, –∑–∞–¥–∞–Ω–Ω—ã–µ –≤ –ê–¥–º–∏–Ω–∫–µ.
*   **Logic:**
    *   –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω -> –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≤—Ö–æ–¥.
    *   –ï—Å–ª–∏ –∫—É–ø–ª–µ–Ω–æ -> –ö–Ω–æ–ø–∫–∞ "–ê–∫—Ç–∏–≤–Ω–æ".

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `Profile.tsx`
*   –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (`free`/`pro`/`lifetime`).
*   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è.
*   –ö–Ω–æ–ø–∫–∞ **"–û—Ç–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ"** (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞).

---

## üõë –ß–µ–∫-–ª–∏—Å—Ç –î–µ–ø–ª–æ—è (Production)

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–Ω—å–≥–∞—Ö —É–±–µ–¥–∏—Ç–µ—Å—å:

1.  **–ÆKassa:**
    *   [ ] –ü–æ–¥–ø–∏—Å–∞–Ω –¥–æ–≥–æ–≤–æ—Ä.
    *   [ ] –ú–∞–≥–∞–∑–∏–Ω –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ **–±–æ–µ–≤–æ–π —Ä–µ–∂–∏–º**.
    *   [ ] –í –ê–¥–º–∏–Ω–∫–µ Anotee –≤–≤–µ–¥–µ–Ω—ã **–±–æ–µ–≤—ã–µ** `ShopID` –∏ `SecretKey`.
    *   [ ] –í –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa URL –≤–µ–±—Ö—É–∫–∞ –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ `https://anotee.com/api/payment?action=webhook`.

2.  **Prodamus (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
    *   [ ] –í–≤–µ–¥–µ–Ω URL –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –≤ –ê–¥–º–∏–Ω–∫–µ.
    *   [ ] –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Prodamus —É–∫–∞–∑–∞–Ω URL —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Notification URL).

3.  **Vercel:**
    *   [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `CRON_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤ –∫–æ–¥–µ/–Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.
    *   [ ] Cron Jobs –≤–∫–ª—é—á–µ–Ω—ã –≤ –¥–∞—à–±–æ—Ä–¥–µ –ø—Ä–æ–µ–∫—Ç–∞.
