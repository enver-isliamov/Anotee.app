name: Deploy to Beget VPS

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Copy files to VPS via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        source: "."
        target: "/root/app"
        overwrite: true

    - name: Execute deployment commands via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        script: |
          cd /root/app
          # Создаем файл .env из секретов GitHub
          echo "${{ secrets.ENV_FILE }}" > .env
          
          # Останавливаем старый контейнер (если есть) и удаляем его
          docker stop anotee || true
          docker rm anotee || true
          
          # Собираем новый образ
          docker build -t anotee .
          
          # Запускаем новый контейнер
          # --restart always: перезапустится сам, если сервер перезагрузится
          # --net host: использует сеть хоста (удобно для простых конфигов) или пробрасываем порты -p 80:3000
          docker run -d -p 80:3000 --env-file .env --name anotee --restart always anotee
