
# Рабочий Воркфлоу Проекта "Anotee"

Этот документ описывает жизненный цикл данных и пользовательский путь в приложении, основанный на текущей архитектуре.

## I. Создание Проекта и Лимиты

1.  **Инициализация**:
    *   Пользователь нажимает "New Project" в Дашборде.
    *   **Динамические Лимиты**: Проверяется количество **личных** проектов (`ownerId === userId`).
    *   Лимит берется из динамической конфигурации в БД (`system_settings` -> `feature_flags`), управляемой через **Admin Panel**.
2.  **Структура Данных**:
    *   Создается запись в таблице `projects` (Postgres).
    *   `owner_id`: ID пользователя Clerk.
    *   `org_id`: ID организации (если активна) или `null` (личный проект).
    *   `assets`: Пустой массив.
3.  **Google Drive (Фоновый процесс)**:
    *   При первом создании или переименовании, `GoogleDriveService` проверяет наличие папки `Anotee.App` в корне Диска пользователя.
    *   Создается подпапка с именем проекта.

## II. Загрузка Медиа (Upload Pipeline)

Логика находится в `hooks/useUploadManager.ts`.

1.  **Выбор Файла**:
    *   Пользователь перетаскивает видео (Drag & Drop) или выбирает через диалог.
    *   **Валидация**: Проверяется тип файла (video/*).
2.  **Клиентская Обработка (Браузер)**:
    *   **Генерация превью**: `generateVideoThumbnail` создает картинку (base64) из 2-й секунды видео, используя Canvas.
    *   **Расчет имени**:
        *   Очистка имени от спецсимволов.
        *   Определение номера версии (v1, v2...).
        *   Формат: `{CleanName}_v{NextNumber}.{ext}`.
3.  **Выбор Хранилища (Storage Selection)**:
    *   Система проверяет наличие активной конфигурации S3 в базе данных (`storage_config`) для **Владельца Проекта**.
    *   **Если S3 активен**: Генерируется Presigned URL (PUT) через API. Файл загружается напрямую в облако (Yandex/AWS/R2).
    *   **Если S3 нет**: Используется Google Drive API (Resumable Upload) с клиента.
4.  **Загрузка**:
    *   Файл отправляется в целевое хранилище.
    *   Для S3 путь: `anotee/{projectId}/{filename}`.
    *   Для Drive путь: `Anotee.App / {ProjectName} / {AssetName}`.
5.  **Синхронизация с БД**:
    *   Обновляется JSON проекта в Postgres.
    *   Добавляется объект `Version` с указанием `storageType` ('s3' или 'drive') и ключами (`s3Key` / `googleDriveId`).

## III. Дашборд и Просмотр (Dashboard & Player)

Логика в `components/Dashboard.tsx` и `components/Player.tsx`.

1.  **Сегментация Проектов**:
    *   В Дашборде списки строго разделены:
        *   **Мои проекты (Owned):** Созданные пользователем. Влияют на лимит создания.
        *   **Доступные мне (Shared):** Проекты, где пользователь — гость или член команды. Не влияют на лимит.
2.  **Инициализация Плеера**:
    *   **Google Drive**: Получение прямой ссылки `uc?export=download`.
    *   **S3**: Генерация временной подписанной ссылки (Presigned GET URL) через API. Ссылка живет 1 час.
    *   **FPS Detection**: При запуске видео используется `requestVideoFrameCallback` для вычисления реальной частоты кадров.
3.  **Таймкоды**:
    *   Все расчеты ведутся в **кадрах** (Total Frames).
    *   `Timecode = Frames / FPS`. Это предотвращает рассинхрон ("дрифт") звука и маркеров.

## IV. Экспорт и Интеграция (NLE)

1.  **Доступ**: Функция экспорта контролируется флагами `export_xml` и `export_csv` (обычно `enabledForPro: true`, `enabledForFree: false`).
2.  **Генерация Файлов**:
    *   Используется `services/exportService.ts`.
3.  **Форматы**:
    *   **DaVinci Resolve (.xml)**: Поддерживает цвета маркеров. Точность до кадра.
    *   **Premiere Pro (.csv)**: Список маркеров для панели Markers.
    *   **EDL**: Универсальный список.

## V. Совместная работа и Доступ (Sharing Model)

Мы внедрили разделение на "Команду" и "Гостей", чтобы обеспечить безопасность данных.

### 1. Модальное окно (Share Modal)
При клике на "Share" в Дашборде открывается окно с двумя вкладками:

*   **Tab: Client Review (Public)**:
    *   **Механика:** Тумблер "Enable Public Access".
    *   **Действие:** Делает проект доступным для чтения по прямой ссылке.
    *   **Приватность:** В этом режиме API (`/api/data`) скрывает список участников команды (`team: []`), чтобы клиенты не видели личные email-адреса редакторов. Пользователь, перешедший по ссылке, **НЕ добавляется** в базу данных.
    
*   **Tab: Invite Team (Member)**:
    *   **Механика:** Ссылка с параметром `?invite=true`.
    *   **Действие:** Пользователь принудительно добавляется в список `team` в базе данных.
    *   **Права:** Полный доступ (Viewer/Editor), проект сохраняется в его Дашборде навсегда.

### 2. Уровни Доступа (Access Levels)
*   **Owner:** Полный доступ, управление настройками и удаление.
*   **Team Member:** Доступ к редактированию и комментированию.
*   **Restricted Guest:** Доступ только к одному конкретному файлу (Asset Sandbox), если ссылка была создана через кнопку "Share" на карточке ассета.
*   **Public Guest:** Только просмотр и комментирование, если включен `Public Access`.

## VI. Биллинг и Динамическая Конфигурация

Логика в `api/payment.js`, `hooks/useSubscription.ts` и `components/RoadmapBlock.tsx`.

1.  **Гибридная Конфигурация**:
    *   В коде (`types.ts`) зашиты дефолтные цены и тексты.
    *   При загрузке фронтенд запрашивает актуальный конфиг из БД (`/api/admin?action=get_payment_config`).
2.  **Инициализация Оплаты**:
    *   Поддерживаются провайдеры: **ЮKassa** и **Prodamus**.
    *   При оплате передается `save_payment_method: true` для рекуррентных списаний (только для Monthly).
3.  **Обработка Webhook**:
    *   При успешной оплате обновляется `publicMetadata` пользователя в Clerk.
    *   Устанавливается `plan: 'pro'` и `expiresAt`.
4.  **Автопродление (Cron)**:
    *   Скрипт `api/cron.js` запускается раз в сутки.
    *   Находит пользователей с истекающим сроком.
    *   Инициирует безакцептное списание через API ЮKassa.

## VII. Администрирование (Admin & RBAC)

Логика в `components/AdminPanel.tsx` и `api/admin.js`.

1.  **Безопасность (Security)**:
    *   Доступ к API администратора (`/api/admin`) защищен проверкой токена.
    *   Права проверяются динамически: Бэкенд делает запрос к Clerk API, чтобы проверить поле `publicMetadata.role`.
    *   Допустимые роли: `admin` или `superadmin`.
    *   **Важно:** Хардкод email-адресов удален.

2.  **Управление Пользователями**:
    *   Таблица всех пользователей с поиском.
    *   Ручная выдача статуса PRO (Lifetime или на срок).
    *   Назначение других администраторов.

3.  **Настройки Системы (Feature Flags)**:
    *   Глобальное управление доступностью функций (AI, Drive, Export).
    *   Изменение лимитов Free-тарифа без деплоя кода.

4.  **Редактор Тарифов**:
    *   Визуальный Drag & Drop редактор карточек тарифов.
    *   Настройка цен и интеграций (ключи API платежек).

## VIII. BYOS (Bring Your Own Storage)

Пользователи могут подключить своё S3-совместимое хранилище (Yandex, Selectel, Cloudflare R2).

1.  **Настройка (Profile)**:
    *   Пользователь вводит Endpoint, Bucket, Access Key, Secret Key.
    *   **Auto-CORS**: Бэкенд автоматически отправляет команду `PutBucketCors` для настройки прав доступа браузера.
2.  **Безопасность**:
    *   `Secret Key` шифруется (AES-256) перед сохранением в БД.
3.  **Воспроизведение**:
    *   Для доступа к файлам используются временные ссылки (Signed URLs), которые генерируются "на лету" при открытии плеера.

## IX. System Diagnostics (QA)

Встроенный инструмент для проверки здоровья системы (`/test`).

1.  **Запуск**: Откройте `https://anotee.com/test`.
2.  **Функции**:
    *   **API Health**: Проверка отклика Vercel Functions.
    *   **Auth Guard**: Проверка защиты приватных роутов (должен вернуть 401).
    *   **Video CDN**: Проверка доступности публичных тестовых файлов (CORS Check).
    *   **Billing Logic**: Симуляция расчета дней подписки.
3.  **Результат**: Health Score (0-100%) и детальный лог ошибок.
