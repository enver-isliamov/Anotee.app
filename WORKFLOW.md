
# Рабочий Воркфлоу Проекта "Anotee"

Этот документ описывает жизненный цикл данных и пользовательский путь в приложении, основанный на текущей архитектуре.

## I. Создание Проекта и Лимиты

1.  **Инициализация**:
    *   Пользователь нажимает "New Project" в Дашборде.
    *   **Динамические Лимиты**: Проверяется количество **личных** проектов (`ownerId === userId`).
    *   Лимит берется из конфигурации приложения (`config.max_projects.limitFree` / `limitPro`), управляемой через **Admin Panel**. Хардкод (3 проекта) используется только как фоллбэк.
2.  **Структура Данных**:
    *   Создается запись в таблице `projects` (Postgres).
    *   `owner_id`: ID пользователя Clerk.
    *   `org_id`: ID организации (если активна) или `null` (личный проект).
    *   `assets`: Пустой массив.
3.  **Google Drive (Фоновый процесс)**:
    *   При первом создании или переименовании, `GoogleDriveService` проверяет наличие папки `Anotee.App` в корне Диска пользователя.
    *   Создается подпапка с именем проекта.

## II. Загрузка Медиа (Upload Pipeline)

Логика находится в `hooks/useUploadManager.ts`.

1.  **Выбор Файла**:
    *   Пользователь перетаскивает видео (Drag & Drop) или выбирает через диалог.
    *   **Валидация**: Проверяется тип файла (video/*).
2.  **Клиентская Обработка (Браузер)**:
    *   **Генерация превью**: `generateVideoThumbnail` создает картинку (base64) из 2-й секунды видео, используя Canvas.
    *   **Расчет имени**:
        *   Очистка имени от спецсимволов.
        *   Определение номера версии (v1, v2...).
        *   Формат: `{CleanName}_v{NextNumber}.{ext}`.
3.  **Выбор Хранилища (Storage Selection)**:
    *   Система проверяет наличие активной конфигурации S3 в базе данных (`storage_config`).
    *   **Если S3 активен**: Генерируется Presigned URL (PUT) через API владельца. Файл загружается напрямую в облако (Yandex/AWS).
    *   **Если S3 нет**: Используется Google Drive API (Resumable Upload) с клиента.
4.  **Загрузка**:
    *   Файл отправляется в целевое хранилище.
    *   Для S3 путь: `anotee/{projectId}/{filename}`.
    *   Для Drive путь: `Anotee.App / {ProjectName} / {AssetName}`.
5.  **Синхронизация с БД**:
    *   Обновляется JSON проекта в Postgres.
    *   Добавляется объект `Version` с указанием `storageType` ('s3' или 'drive').

## III. Дашборд и Просмотр (Dashboard & Player)

Логика в `components/Dashboard.tsx` и `components/Player.tsx`.

1.  **Сегментация Проектов**:
    *   В Дашборде списки строго разделены:
        *   **Мои проекты (Owned):** Созданные пользователем. Влияют на лимит создания.
        *   **Доступные мне (Shared):** Проекты, где пользователь — гость или член команды. Не влияют на лимит.
2.  **Инициализация Плеера**:
    *   **Google Drive**: Получение прямой ссылки `uc?export=download`.
    *   **S3**: Генерация временной подписанной ссылки (Presigned GET URL) через API. Ссылка живет 1 час.
    *   **FPS Detection**: При запуске видео используется `requestVideoFrameCallback` для вычисления реальной частоты кадров.
3.  **Таймкоды**:
    *   Все расчеты ведутся в **кадрах** (Total Frames).
    *   `Timecode = Frames / FPS`. Это предотвращает рассинхрон ("дрифт") звука и маркеров.

## IV. Экспорт и Интеграция (NLE)

1.  **Доступ**: Функция экспорта контролируется флагами `export_xml` и `export_csv` (обычно `enabledForPro: true`, `enabledForFree: false`).
2.  **Генерация Файлов**:
    *   Используется `services/exportService.ts`.
3.  **Форматы**:
    *   **DaVinci Resolve (.xml)**: Поддерживает цвета маркеров. Точность до кадра.
    *   **Premiere Pro (.csv)**: Список маркеров для панели Markers.
    *   **EDL**: Универсальный список.

## V. Совместная работа и Доступ

1.  **Модель Доступа**:
    *   **Owner**: Полный доступ.
    *   **Org Member**: Доступ ко всем проектам организации.
    *   **Guest (Link)**: Если включен `Public Access`, доступ на просмотр.
2.  **Ограничения Шеринга (Config)**:
    *   Возможность поделиться проектом (кнопки "Share", "Invite") контролируется флагом `team_collab`.
    *   **Free**: По умолчанию `enabledForFree: false`. Пользователь может создавать и смотреть свои проекты, но не может приглашать других (Solo Mode). Он может *быть приглашенным* в чужие проекты.
    *   **Pro**: Шеринг разрешен.
3.  **Приглашения**:
    *   Email Invite (Legacy/Personal).
    *   Clerk Organizations (Team Management).

## VI. Биллинг и Динамическая Конфигурация

Логика в `api/payment.js`, `hooks/useSubscription.ts` и `components/RoadmapBlock.tsx`.

1.  **Гибридная Конфигурация**:
    *   В коде (`types.ts`) зашиты дефолтные цены и тексты.
    *   При загрузке фронтенд запрашивает актуальный конфиг из БД (`/api/admin?action=get_payment_config`).
    *   **Skeleton UI**: Чтобы избежать скачка цен (FOUC), компоненты показывают "скелет" до загрузки данных из БД.
2.  **Инициализация Оплаты**:
    *   Поддерживаются провайдеры: **ЮKassa** и **Prodamus**.
    *   При оплате передается `save_payment_method: true` для рекуррентных списаний (только для Monthly).
3.  **Обработка Webhook**:
    *   При успешной оплате обновляется `publicMetadata` пользователя в Clerk.
    *   Устанавливается `plan: 'pro'` и `expiresAt`.
4.  **Автопродление (Cron)**:
    *   Скрипт `api/cron.js` запускается раз в сутки.
    *   Находит пользователей с истекающим сроком.
    *   Инициирует безакцептное списание через API ЮKassa.

## VII. Администрирование

Логика в `components/AdminPanel.tsx` и `api/admin.js`.

1.  **Управление Пользователями**:
    *   Просмотр списка всех пользователей.
    *   Ручная выдача/отзыв статуса PRO (Lifetime или временный).
2.  **Настройки Системы (Feature Flags)**:
    *   Глобальное включение/отключение функций (например, AI Transcription, Google Drive).
    *   **Управление Лимитами**: Изменение `limitFree` (кол-во проектов) без деплоя кода.
    *   **Доступ к Шерингу**: Включение/отключение `team_collab` для Free тарифа.
3.  **Редактор Тарифов (Plan Builder)**:
    *   Управление ценами, заголовками и списком фич для каждого тарифа.
    *   Переключение видимости тарифов ("Активно" / "Скоро").
    *   Конфигурация ключей API платежных систем.

## VIII. BYOS (Bring Your Own Storage)

Пользователи могут подключить своё S3-совместимое хранилище (Yandex, Selectel, Cloudflare R2).

1.  **Настройка (Profile)**:
    *   Пользователь вводит Endpoint, Bucket, Access Key, Secret Key.
    *   **Auto-CORS**: Бэкенд автоматически отправляет команду `PutBucketCors` для настройки прав доступа браузера.
2.  **Безопасность**:
    *   `Secret Key` шифруется (AES-256) перед сохранением в БД.
    *   Ключи никогда не передаются на фронтенд.
3.  **Воспроизведение**:
    *   Для доступа к файлам используются временные ссылки (Signed URLs), которые генерируются "на лету" при открытии плеера.
