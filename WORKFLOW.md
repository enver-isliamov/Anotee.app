
# Рабочий Воркфлоу Проекта "SmoTree" (Anotee)

Этот документ описывает жизненный цикл данных и пользовательский путь в приложении, основанный на текущей архитектуре.

## I. Создание Проекта

1.  **Инициализация**:
    *   Пользователь нажимает "New Project" в Дашборде.
    *   Проверяется лимит проектов (Free: макс. 3, Pro: безлимит) на основе `metadata.plan`.
2.  **Структура Данных**:
    *   Создается запись в таблице `projects` (Postgres).
    *   `owner_id`: ID пользователя Clerk.
    *   `org_id`: ID организации (если активна) или `null` (личный проект).
    *   `assets`: Пустой массив.
3.  **Google Drive (Фоновый процесс)**:
    *   При первом создании или переименовании, `GoogleDriveService` проверяет наличие папки `Anotee.App` в корне Диска пользователя.
    *   Создается подпапка с именем проекта.

## II. Загрузка Медиа (Upload Pipeline)

Логика находится в `hooks/useUploadManager.ts`.

1.  **Выбор Файла**:
    *   Пользователь перетаскивает видео (Drag & Drop) или выбирает через диалог.
    *   **Валидация**: Проверяется тип файла (video/*).
2.  **Клиентская Обработка (Браузер)**:
    *   **Генерация превью**: `generateVideoThumbnail` создает картинку (base64) из 2-й секунды видео, используя Canvas. Это происходит *до* загрузки, чтобы интерфейс был отзывчивым.
    *   **Расчет имени**:
        *   Очистка имени от спецсимволов.
        *   Определение номера версии.
        *   Формат: `{CleanName}_v{NextNumber}.{ext}` (например, `Commercial_Cut_v2.mp4`).
3.  **Загрузка в Google Drive**:
    *   Используется Resumable Upload (для больших файлов).
    *   Файл помещается в иерархию: `Anotee.App / {ProjectName} / {AssetName}`.
4.  **Настройка Прав (Критично)**:
    *   Сразу после загрузки вызывается `GoogleDriveService.makeFilePublic(fileId)`.
    *   Это делает файл доступным по ссылке ("Anyone with link"), что необходимо для HTML5 плеера.
5.  **Синхронизация с БД**:
    *   Обновляется JSON проекта в Postgres.
    *   Добавляется объект `Version` с `googleDriveId` и `storageType: 'drive'`.

## III. Просмотр и Ревью (Player Engine)

Логика в `components/Player.tsx`.

1.  **Инициализация Плеера**:
    *   Получение прямой ссылки на поток: `https://drive.google.com/uc?export=download&id={ID}`.
    *   **FPS Detection**: При запуске видео используется `requestVideoFrameCallback` для вычисления реальной частоты кадров (23.976, 24, 25, 30, 60 и т.д.).
2.  **Таймкоды**:
    *   Все расчеты ведутся в **кадрах** (Total Frames).
    *   `Timecode = Frames / FPS`. Это предотвращает рассинхрон ("дрифт") звука и маркеров.
3.  **Комментарии**:
    *   **Точечные**: Привязаны к конкретному timestamp.
    *   **Диапазон (Range)**: Имеют `timestamp` (In) и `duration` (Out - In).
    *   Синхронизация: Optimistic UI (сразу показывает комментарий) + фоновая отправка в `api/comment.js`.

## IV. Экспорт и Интеграция (NLE)

1.  **Генерация Файлов**:
    *   Используется `services/exportService.ts`.
    *   Данные комментариев конвертируются в форматы монтажных программ.
2.  **Форматы**:
    *   **DaVinci Resolve (.xml)**: Поддерживает цвета маркеров (Зеленый = Resolved, Красный = Open). Точность до кадра.
    *   **Premiere Pro (.csv)**: Список маркеров для панели Markers.
    *   **EDL**: Универсальный список монтажных решений.

## V. Совместная работа и Доступ

1.  **Модель Доступа**:
    *   **Owner**: Полный доступ (удаление, редактирование, управление командой).
    *   **Org Member**: Доступ ко всем проектам организации (согласно роли в Clerk).
    *   **Guest (Link)**: Если включен `Public Access`, любой, у кого есть ссылка, может просматривать (View Only).
2.  **Приглашения**:
    *   Добавление по Email (для Личных проектов).
    *   Добавление в Организацию (через интерфейс Clerk).
